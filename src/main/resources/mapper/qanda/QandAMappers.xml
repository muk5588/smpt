<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="QandA.dao.QandADao">

    <!-- 게시물 목록 -->
    <select id="list" parameterType="QandA.dto.SearchCriteria" resultType="QandA.dto.QandaVO">
        SELECT boardNo, title, nickname, userno, content, createDate, imagePath, boardview, recommendCount
        FROM (
            SELECT boardNo, title, nickname, userno, content, createDate, imagePath, boardview, recommendCount,
            ROW_NUMBER() OVER (
                ORDER BY
                <choose>
                    <when test="sortType == 'popular'">
                        recommendCount DESC
                    </when>
                    <when test="sortType == 'views'">
                        boardview DESC
                    </when>
                    <otherwise>
                        boardNo DESC
                    </otherwise>
                </choose>
            ) AS RNUM
            FROM qanda
            <include refid="search"/>
        ) SY
        WHERE RNUM BETWEEN #{rowStart} AND #{rowEnd}
    </select>

    <!-- 검색기능 -->
    <select id="countSearch" resultType="int">
        select count(boardNo)
        from qanda
        <include refid="search"></include>
        and boardNo > 0
    </select>

    <sql id="search">
        <where>
            boardNo > 0
            <if test="searchType != null">
                <if test="searchType == 't'.toString()">and title like '%' || #{keyword} || '%'</if>
                <if test="searchType == 'c'.toString()">and content like '%' || #{keyword} || '%'</if>
                <if test="searchType == 'w'.toString()">and nickname like '%' || #{keyword} || '%'</if>
                <if test="searchType == 'tc'.toString()">and (title like '%' || #{keyword} || '%') or (content
                    like '%' || #{keyword} || '%')</if>
            </if>
        </where>
    </sql>

    <!-- 페이징 기능 -->
    <select id="listCount" resultType="int">
    <![CDATA[
        SELECT COUNT(boardNo)
        FROM qanda
        WHERE boardNo > 0
    ]]>
    </select>

    <!-- 게시물 작성 -->
    <insert id="create">
        insert into qanda(CategoryNo, boardNo, title,
        nickname, userno, content, imagePath)
        values(#{CategoryNo},
        QANDA_SEQ.NEXTVAL,
        #{title}, #{nickname},
        #{userno}, #{content},
        #{imagePath})
    </insert>

    <!-- 게시물 조회 -->
    <select id="detail" parameterType="int">
        select
        boardNo, title, userno,
        content, createDate, nickname, imagePath,boardview
        from
        qanda
        where
        boardNo = #{boardNo}
    </select>

    <!-- 게시물 수정 -->
    <update id="update">
        update qanda
        set
        title = #{title},
        content = #{content},
        nickname = #{nickname}
        where boardNo = #{boardNo}
    </update>

    <!-- 게시물 삭제 -->
    <delete id="delete" parameterType="int">
        delete
        from qanda
        where boardNo = #{boardNo}
    </delete>

    <!-- 추천 수 증가 -->
    <update id="incrementRecommendCount">
        UPDATE qanda
        SET recommendCount = recommendCount + 1
        WHERE boardNo = #{boardNo}
    </update>

    <!-- 추천 수 조회 -->
    <select id="getRecommendCount" parameterType="int"
        resultType="int">
        SELECT recommendCount
        FROM qanda
        WHERE boardNo = #{boardNo}
    </select>

    <!-- 중복 추천 여부 확인 -->
    <select id="hasRecommended" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM RECOMMEND_RECORD
        WHERE userno = #{userno} AND boardNo = #{boardNo}
    </select>

    <!-- 추천 기록 추가 -->
    <insert id="addRecommendRecord" parameterType="map">
        INSERT INTO RECOMMEND_RECORD (userno, boardNo)
        VALUES (#{userno}, #{boardNo})
    </insert>

    <!-- 추천 기록 삭제 -->
    <delete id="deleteRecommendRecords" parameterType="int">
        DELETE FROM RECOMMEND_RECORD WHERE boardNo = #{boardNo}
    </delete>

    <!-- 조회 수 증가 -->
    <update id="incrementViewCount">
        UPDATE qanda
        SET boardview = boardview + 1
        WHERE boardNo = #{boardNo}
    </update>

    <!-- 게시판 분류 목록 조회 -->
    <select id="getCategoryList" resultType="Category">
        SELECT CategoryNo, CategoryName FROM CATEGORY
    </select>
</mapper>
